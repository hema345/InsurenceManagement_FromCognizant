2025-05-28 17:01:16.691 +05:30 [INF] User profile is available. Using 'C:\Users\2403521\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-28 17:01:17.050 +05:30 [INF] Now listening on: http://localhost:5016
2025-05-28 17:01:17.224 +05:30 [INF] Application started. Press Ctrl+C to shut down.
2025-05-28 17:01:17.225 +05:30 [INF] Hosting environment: Development
2025-05-28 17:01:17.226 +05:30 [INF] Content root path: C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi
2025-05-28 17:01:18.002 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/swagger/index.html - null null
2025-05-28 17:01:20.470 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/swagger/index.html - 200 null text/html;charset=utf-8 2485.1754ms
2025-05-28 17:01:20.495 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/_framework/aspnetcore-browser-refresh.js - null null
2025-05-28 17:01:20.499 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/_framework/aspnetcore-browser-refresh.js - 200 16547 application/javascript; charset=utf-8 4.83ms
2025-05-28 17:01:20.506 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/_vs/browserLink - null null
2025-05-28 17:01:20.609 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/_vs/browserLink - 200 null text/javascript; charset=UTF-8 103.6173ms
2025-05-28 17:01:20.685 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/swagger/v1/swagger.json - null null
2025-05-28 17:01:20.741 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/swagger/v1/swagger.json - 200 null application/json;charset=utf-8 55.7498ms
2025-05-28 17:01:26.665 +05:30 [INF] Request starting HTTP/1.1 POST http://localhost:5016/api/Auth/login - application/json 61
2025-05-28 17:01:26.672 +05:30 [WRN] Failed to determine the https port for redirect.
2025-05-28 17:01:26.676 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi)'
2025-05-28 17:01:26.699 +05:30 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(InsurenceManagementSystemWebApi.Applications.DTOs.LoginRequestDto) on controller InsurenceManagementSystemWebApi.Controllers.AuthController (InsurenceManagementSystemWebApi).
2025-05-28 17:01:29.242 +05:30 [INF] Executed DbCommand (167ms) [Parameters=[@__username_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[Id], [u].[IsDeleted], [u].[PasswordHash], [u].[Username], [u0].[UserId], [u0].[RoleId], [r].[Id], [r].[Name]
FROM [Users] AS [u]
LEFT JOIN [UserRoles] AS [u0] ON [u].[Id] = [u0].[UserId]
LEFT JOIN [Roles] AS [r] ON [u0].[RoleId] = [r].[Id]
WHERE [u].[Username] = @__username_0
2025-05-28 17:01:29.629 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.LoginResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-28 17:01:29.636 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi) in 2933.8492ms
2025-05-28 17:01:29.639 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi)'
2025-05-28 17:01:29.650 +05:30 [INF] Request finished HTTP/1.1 POST http://localhost:5016/api/Auth/login - 200 null application/json; charset=utf-8 2984.5937ms
2025-05-28 17:01:52.618 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/api/Customer/policies - null null
2025-05-28 17:01:52.668 +05:30 [INF] Failed to validate the token.
Microsoft.IdentityModel.Tokens.SecurityTokenExpiredException: IDX10223: Lifetime validation failed. The token is expired. ValidTo (UTC): '5/27/2025 9:55:43 AM', Current time (UTC): '5/28/2025 11:31:52 AM'.
   at Microsoft.IdentityModel.Tokens.Validators.ValidateLifetime(Nullable`1 notBefore, Nullable`1 expires, SecurityToken securityToken, TokenValidationParameters validationParameters)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateTokenPayloadAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
   at Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler.ValidateJWSAsync(JsonWebToken jsonWebToken, TokenValidationParameters validationParameters, BaseConfiguration configuration)
2025-05-28 17:01:52.699 +05:30 [INF] Bearer was not authenticated. Failure message: IDX10223: Lifetime validation failed. The token is expired. ValidTo (UTC): '5/27/2025 9:55:43 AM', Current time (UTC): '5/28/2025 11:31:52 AM'.
2025-05-28 17:01:52.708 +05:30 [INF] Authorization failed. These requirements were not met:
RolesAuthorizationRequirement:User.IsInRole must be true for one of the following roles: (Customer)
2025-05-28 17:01:52.714 +05:30 [INF] AuthenticationScheme: Bearer was challenged.
2025-05-28 17:01:52.716 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/api/Customer/policies - 401 0 null 97.9081ms
2025-05-28 17:02:37.377 +05:30 [INF] Request starting HTTP/1.1 POST http://localhost:5016/api/Auth/login - application/json 63
2025-05-28 17:02:37.381 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi)'
2025-05-28 17:02:37.382 +05:30 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(InsurenceManagementSystemWebApi.Applications.DTOs.LoginRequestDto) on controller InsurenceManagementSystemWebApi.Controllers.AuthController (InsurenceManagementSystemWebApi).
2025-05-28 17:02:37.422 +05:30 [INF] Executed DbCommand (16ms) [Parameters=[@__username_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[Id], [u].[IsDeleted], [u].[PasswordHash], [u].[Username], [u0].[UserId], [u0].[RoleId], [r].[Id], [r].[Name]
FROM [Users] AS [u]
LEFT JOIN [UserRoles] AS [u0] ON [u].[Id] = [u0].[UserId]
LEFT JOIN [Roles] AS [r] ON [u0].[RoleId] = [r].[Id]
WHERE [u].[Username] = @__username_0
2025-05-28 17:02:37.612 +05:30 [INF] Executed DbCommand (13ms) [Parameters=[@__userId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[CustomerId], [c].[Address], [c].[DateOfBirth], [c].[Email], [c].[Name], [c].[Phone], [c].[UserId]
FROM [Customers] AS [c]
WHERE [c].[UserId] = @__userId_0
2025-05-28 17:02:37.630 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.LoginResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-28 17:02:37.632 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi) in 247.7179ms
2025-05-28 17:02:37.633 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi)'
2025-05-28 17:02:37.635 +05:30 [INF] Request finished HTTP/1.1 POST http://localhost:5016/api/Auth/login - 200 null application/json; charset=utf-8 257.8736ms
2025-05-28 17:03:27.684 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/api/Customer/policies - null null
2025-05-28 17:03:27.707 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.CustomerController.GetRegisteredPolicies (InsurenceManagementSystemWebApi)'
2025-05-28 17:03:27.717 +05:30 [INF] Route matched with {action = "GetRegisteredPolicies", controller = "Customer"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetRegisteredPolicies() on controller InsurenceManagementSystemWebApi.Controllers.CustomerController (InsurenceManagementSystemWebApi).
2025-05-28 17:03:27.805 +05:30 [INF] Executed DbCommand (25ms) [Parameters=[@__customerId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[PolicyId], [p].[AgentId], [p].[AvailablePolicyId], [p].[CustomerId], [p].[ExpiryDate], [p].[IssuedDate], [a].[AgentId], [a].[ContactInfo], [a].[Name], [a].[UserId], [a0].[AvailablePolicyId], [a0].[BasePremium], [a0].[CoverageDetails], [a0].[Name], [a0].[ValidityPeriod]
FROM [Policies] AS [p]
INNER JOIN [Agents] AS [a] ON [p].[AgentId] = [a].[AgentId]
INNER JOIN [AvailablePolicies] AS [a0] ON [p].[AvailablePolicyId] = [a0].[AvailablePolicyId]
WHERE [p].[CustomerId] = @__customerId_0
2025-05-28 17:03:27.836 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[System.Collections.Generic.IEnumerable`1[[InsurenceManagementSystemWebApi.Applications.DTOs.CustomerPoliciesResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-28 17:03:27.858 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.CustomerController.GetRegisteredPolicies (InsurenceManagementSystemWebApi) in 138.7113ms
2025-05-28 17:03:27.863 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.CustomerController.GetRegisteredPolicies (InsurenceManagementSystemWebApi)'
2025-05-28 17:03:27.867 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/api/Customer/policies - 200 null application/json; charset=utf-8 183.1958ms
2025-05-28 17:11:25.922 +05:30 [INF] User profile is available. Using 'C:\Users\2403521\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-28 17:11:26.188 +05:30 [INF] Now listening on: http://localhost:5016
2025-05-28 17:11:26.310 +05:30 [INF] Application started. Press Ctrl+C to shut down.
2025-05-28 17:11:26.318 +05:30 [INF] Hosting environment: Development
2025-05-28 17:11:26.320 +05:30 [INF] Content root path: C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi
2025-05-28 17:11:27.158 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/swagger/index.html - null null
2025-05-28 17:11:27.952 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/swagger/index.html - 200 null text/html;charset=utf-8 807.0985ms
2025-05-28 17:11:27.972 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/_vs/browserLink - null null
2025-05-28 17:11:28.017 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/_framework/aspnetcore-browser-refresh.js - null null
2025-05-28 17:11:28.053 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/_framework/aspnetcore-browser-refresh.js - 200 16547 application/javascript; charset=utf-8 36.2012ms
2025-05-28 17:11:28.117 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/_vs/browserLink - 200 null text/javascript; charset=UTF-8 145.2936ms
2025-05-28 17:11:28.397 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/swagger/v1/swagger.json - null null
2025-05-28 17:11:28.484 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/swagger/v1/swagger.json - 200 null application/json;charset=utf-8 86.901ms
2025-05-28 17:11:33.652 +05:30 [INF] Request starting HTTP/1.1 POST http://localhost:5016/api/Auth/login - application/json 61
2025-05-28 17:11:33.670 +05:30 [WRN] Failed to determine the https port for redirect.
2025-05-28 17:11:33.676 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi)'
2025-05-28 17:11:33.715 +05:30 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(InsurenceManagementSystemWebApi.Applications.DTOs.LoginRequestDto) on controller InsurenceManagementSystemWebApi.Controllers.AuthController (InsurenceManagementSystemWebApi).
2025-05-28 17:11:35.849 +05:30 [INF] Executed DbCommand (193ms) [Parameters=[@__username_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[Id], [u].[IsDeleted], [u].[PasswordHash], [u].[Username], [u0].[UserId], [u0].[RoleId], [r].[Id], [r].[Name]
FROM [Users] AS [u]
LEFT JOIN [UserRoles] AS [u0] ON [u].[Id] = [u0].[UserId]
LEFT JOIN [Roles] AS [r] ON [u0].[RoleId] = [r].[Id]
WHERE [u].[Username] = @__username_0
2025-05-28 17:11:36.152 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.LoginResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-28 17:11:36.164 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi) in 2442.4853ms
2025-05-28 17:11:36.167 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi)'
2025-05-28 17:11:36.180 +05:30 [INF] Request finished HTTP/1.1 POST http://localhost:5016/api/Auth/login - 200 null application/json; charset=utf-8 2527.6718ms
2025-05-28 17:13:17.181 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/api/Admin/users - null null
2025-05-28 17:13:17.215 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllUsers (InsurenceManagementSystemWebApi)'
2025-05-28 17:13:17.220 +05:30 [INF] Route matched with {action = "GetAllUsers", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult`1[System.Collections.Generic.IEnumerable`1[InsurenceManagementSystemWebApi.Applications.DTOs.UserWithRoleResponseDto]]] GetAllUsers() on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 17:13:17.256 +05:30 [INF] Executed DbCommand (12ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[Id], [u].[IsDeleted], [u].[PasswordHash], [u].[Username], [u0].[UserId], [u0].[RoleId], [r].[Id], [r].[Name]
FROM [Users] AS [u]
LEFT JOIN [UserRoles] AS [u0] ON [u].[Id] = [u0].[UserId]
LEFT JOIN [Roles] AS [r] ON [u0].[RoleId] = [r].[Id]
2025-05-28 17:13:17.263 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[System.Collections.Generic.IEnumerable`1[[InsurenceManagementSystemWebApi.Applications.DTOs.UserWithRoleResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-28 17:13:17.275 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllUsers (InsurenceManagementSystemWebApi) in 52.9603ms
2025-05-28 17:13:17.277 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllUsers (InsurenceManagementSystemWebApi)'
2025-05-28 17:13:17.278 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/api/Admin/users - 200 null application/json; charset=utf-8 97.0815ms
2025-05-28 17:14:19.906 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/api/Admin/customers - null null
2025-05-28 17:14:19.912 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllCustomers (InsurenceManagementSystemWebApi)'
2025-05-28 17:14:19.920 +05:30 [INF] Route matched with {action = "GetAllCustomers", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult`1[InsurenceManagementSystemWebApi.Applications.DTOs.PagedResult`1[InsurenceManagementSystemWebApi.Applications.DTOs.CustomerProfileResponseDto]]] GetAllCustomers(Int32, Int32) on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 17:14:19.981 +05:30 [INF] Executed DbCommand (10ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [c].[CustomerId], [c].[Address], [c].[DateOfBirth], [c].[Email], [c].[Name], [c].[Phone], [c].[UserId]
FROM [Customers] AS [c]
2025-05-28 17:14:20.001 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.PagedResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.CustomerProfileResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-28 17:14:20.010 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllCustomers (InsurenceManagementSystemWebApi) in 87.8488ms
2025-05-28 17:14:20.013 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllCustomers (InsurenceManagementSystemWebApi)'
2025-05-28 17:14:20.015 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/api/Admin/customers - 200 null application/json; charset=utf-8 108.7223ms
2025-05-28 17:14:34.053 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/api/Admin/agents - null null
2025-05-28 17:14:34.058 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllAgents (InsurenceManagementSystemWebApi)'
2025-05-28 17:14:34.062 +05:30 [INF] Route matched with {action = "GetAllAgents", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetAllAgents(Int32, Int32) on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 17:14:34.085 +05:30 [INF] Executed DbCommand (7ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [a].[AgentId], [a].[ContactInfo], [a].[Name], [a].[UserId]
FROM [Agents] AS [a]
2025-05-28 17:14:34.097 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.PagedResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.AgentProfileResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-28 17:14:34.103 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllAgents (InsurenceManagementSystemWebApi) in 37.4392ms
2025-05-28 17:14:34.106 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllAgents (InsurenceManagementSystemWebApi)'
2025-05-28 17:14:34.108 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/api/Admin/agents - 200 null application/json; charset=utf-8 54.8448ms
2025-05-28 17:36:16.541 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/api/Customer/profile - null null
2025-05-28 17:36:16.560 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.CustomerController.GetProfile (InsurenceManagementSystemWebApi)'
2025-05-28 17:36:16.569 +05:30 [INF] Route matched with {action = "GetProfile", controller = "Customer"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetProfile() on controller InsurenceManagementSystemWebApi.Controllers.CustomerController (InsurenceManagementSystemWebApi).
2025-05-28 17:36:16.645 +05:30 [INF] Executed DbCommand (21ms) [Parameters=[@__customerId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[CustomerId], [c].[Address], [c].[DateOfBirth], [c].[Email], [c].[Name], [c].[Phone], [c].[UserId]
FROM [Customers] AS [c]
WHERE [c].[CustomerId] = @__customerId_0
2025-05-28 17:36:16.649 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.CustomerProfileResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-28 17:36:16.652 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.CustomerController.GetProfile (InsurenceManagementSystemWebApi) in 80.5357ms
2025-05-28 17:36:16.655 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.CustomerController.GetProfile (InsurenceManagementSystemWebApi)'
2025-05-28 17:36:16.658 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/api/Customer/profile - 200 null application/json; charset=utf-8 118.8489ms
2025-05-28 17:39:15.873 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/api/Admin/users - null null
2025-05-28 17:39:15.905 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllUsers (InsurenceManagementSystemWebApi)'
2025-05-28 17:39:15.913 +05:30 [INF] Route matched with {action = "GetAllUsers", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult`1[System.Collections.Generic.IEnumerable`1[InsurenceManagementSystemWebApi.Applications.DTOs.UserWithRoleResponseDto]]] GetAllUsers() on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 17:39:15.995 +05:30 [INF] Executed DbCommand (51ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [u].[Id], [u].[IsDeleted], [u].[PasswordHash], [u].[Username], [u0].[UserId], [u0].[RoleId], [r].[Id], [r].[Name]
FROM [Users] AS [u]
LEFT JOIN [UserRoles] AS [u0] ON [u].[Id] = [u0].[UserId]
LEFT JOIN [Roles] AS [r] ON [u0].[RoleId] = [r].[Id]
2025-05-28 17:39:16.009 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[System.Collections.Generic.IEnumerable`1[[InsurenceManagementSystemWebApi.Applications.DTOs.UserWithRoleResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-28 17:39:16.016 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllUsers (InsurenceManagementSystemWebApi) in 86.0922ms
2025-05-28 17:39:16.024 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllUsers (InsurenceManagementSystemWebApi)'
2025-05-28 17:39:16.033 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/api/Admin/users - 200 null application/json; charset=utf-8 159.6046ms
2025-05-28 17:40:17.924 +05:30 [INF] Request starting HTTP/1.1 POST http://localhost:5016/api/Auth/login - application/json 57
2025-05-28 17:40:17.933 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi)'
2025-05-28 17:40:17.939 +05:30 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(InsurenceManagementSystemWebApi.Applications.DTOs.LoginRequestDto) on controller InsurenceManagementSystemWebApi.Controllers.AuthController (InsurenceManagementSystemWebApi).
2025-05-28 17:40:17.963 +05:30 [INF] Executed DbCommand (11ms) [Parameters=[@__username_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[Id], [u].[IsDeleted], [u].[PasswordHash], [u].[Username], [u0].[UserId], [u0].[RoleId], [r].[Id], [r].[Name]
FROM [Users] AS [u]
LEFT JOIN [UserRoles] AS [u0] ON [u].[Id] = [u0].[UserId]
LEFT JOIN [Roles] AS [r] ON [u0].[RoleId] = [r].[Id]
WHERE [u].[Username] = @__username_0
2025-05-28 17:40:18.226 +05:30 [INF] Executed DbCommand (4ms) [Parameters=[@__userId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[CustomerId], [c].[Address], [c].[DateOfBirth], [c].[Email], [c].[Name], [c].[Phone], [c].[UserId]
FROM [Customers] AS [c]
WHERE [c].[UserId] = @__userId_0
2025-05-28 17:40:18.232 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.LoginResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-28 17:40:18.233 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi) in 288.2944ms
2025-05-28 17:40:18.235 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi)'
2025-05-28 17:40:18.237 +05:30 [INF] Request finished HTTP/1.1 POST http://localhost:5016/api/Auth/login - 200 null application/json; charset=utf-8 312.4302ms
2025-05-28 17:47:42.327 +05:30 [INF] Request starting HTTP/1.1 POST http://localhost:5016/api/Auth/login - application/json 57
2025-05-28 17:47:42.344 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi)'
2025-05-28 17:47:42.355 +05:30 [INF] Route matched with {action = "Login", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] Login(InsurenceManagementSystemWebApi.Applications.DTOs.LoginRequestDto) on controller InsurenceManagementSystemWebApi.Controllers.AuthController (InsurenceManagementSystemWebApi).
2025-05-28 17:47:42.438 +05:30 [INF] Executed DbCommand (12ms) [Parameters=[@__username_0='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[Id], [u].[IsDeleted], [u].[PasswordHash], [u].[Username], [u0].[UserId], [u0].[RoleId], [r].[Id], [r].[Name]
FROM [Users] AS [u]
LEFT JOIN [UserRoles] AS [u0] ON [u].[Id] = [u0].[UserId]
LEFT JOIN [Roles] AS [r] ON [u0].[RoleId] = [r].[Id]
WHERE [u].[Username] = @__username_0
2025-05-28 17:47:42.599 +05:30 [INF] Executed DbCommand (3ms) [Parameters=[@__userId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [c].[CustomerId], [c].[Address], [c].[DateOfBirth], [c].[Email], [c].[Name], [c].[Phone], [c].[UserId]
FROM [Customers] AS [c]
WHERE [c].[UserId] = @__userId_0
2025-05-28 17:47:42.603 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.LoginResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-28 17:47:42.604 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi) in 232.7589ms
2025-05-28 17:47:42.607 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AuthController.Login (InsurenceManagementSystemWebApi)'
2025-05-28 17:47:42.609 +05:30 [INF] Request finished HTTP/1.1 POST http://localhost:5016/api/Auth/login - 200 null application/json; charset=utf-8 287.8312ms
2025-05-28 17:48:40.741 +05:30 [INF] Request starting HTTP/1.1 DELETE http://localhost:5016/api/Customer/delete-account - null null
2025-05-28 17:48:40.772 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.CustomerController.DeleteAccount (InsurenceManagementSystemWebApi)'
2025-05-28 17:48:40.787 +05:30 [INF] Route matched with {action = "DeleteAccount", controller = "Customer"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] DeleteAccount() on controller InsurenceManagementSystemWebApi.Controllers.CustomerController (InsurenceManagementSystemWebApi).
2025-05-28 17:48:40.844 +05:30 [INF] Executed DbCommand (6ms) [Parameters=[@__p_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[Id], [u].[IsDeleted], [u].[PasswordHash], [u].[Username]
FROM [Users] AS [u]
WHERE [u].[Id] = @__p_0
2025-05-28 17:48:40.976 +05:30 [INF] Executed DbCommand (26ms) [Parameters=[@p1='?' (DbType = Guid), @p0='?' (DbType = Boolean)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [Users] SET [IsDeleted] = @p0
OUTPUT 1
WHERE [Id] = @p1;
2025-05-28 17:48:41.015 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-28 17:48:41.027 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.CustomerController.DeleteAccount (InsurenceManagementSystemWebApi) in 230.9157ms
2025-05-28 17:48:41.038 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.CustomerController.DeleteAccount (InsurenceManagementSystemWebApi)'
2025-05-28 17:48:41.047 +05:30 [INF] Request finished HTTP/1.1 DELETE http://localhost:5016/api/Customer/delete-account - 200 null application/json; charset=utf-8 305.05ms
2025-05-28 17:57:48.490 +05:30 [INF] Request starting HTTP/1.1 PUT http://localhost:5016/api/Admin/2/available-policy - application/json 106
2025-05-28 17:57:48.499 +05:30 [INF] Executing endpoint '405 HTTP Method Not Supported'
2025-05-28 17:57:48.515 +05:30 [INF] Executed endpoint '405 HTTP Method Not Supported'
2025-05-28 17:57:48.517 +05:30 [INF] Request finished HTTP/1.1 PUT http://localhost:5016/api/Admin/2/available-policy - 405 0 null 26.6332ms
2025-05-28 17:58:28.585 +05:30 [INF] Request starting HTTP/1.1 PUT http://localhost:5016/api/Admin/2/available-policy - application/json 106
2025-05-28 17:58:28.600 +05:30 [INF] Executing endpoint '405 HTTP Method Not Supported'
2025-05-28 17:58:28.603 +05:30 [INF] Executed endpoint '405 HTTP Method Not Supported'
2025-05-28 17:58:28.604 +05:30 [INF] Request finished HTTP/1.1 PUT http://localhost:5016/api/Admin/2/available-policy - 405 0 null 19.4091ms
2025-05-28 17:59:27.572 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/api/Admin/available-policies/?page=1 - null null
2025-05-28 17:59:27.586 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllAvailablePolicies (InsurenceManagementSystemWebApi)'
2025-05-28 17:59:27.592 +05:30 [INF] Route matched with {action = "GetAllAvailablePolicies", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult`1[InsurenceManagementSystemWebApi.Applications.DTOs.PagedResult`1[InsurenceManagementSystemWebApi.Applications.DTOs.AvailablePolicyResponseDto]]] GetAllAvailablePolicies(Int32, Int32) on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 17:59:27.617 +05:30 [INF] GetAllAvailablePoliciesAsync started
2025-05-28 17:59:27.643 +05:30 [INF] Executed DbCommand (4ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [a].[AvailablePolicyId], [a].[BasePremium], [a].[CoverageDetails], [a].[Name], [a].[ValidityPeriod]
FROM [AvailablePolicies] AS [a]
2025-05-28 17:59:27.673 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.PagedResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.AvailablePolicyResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-28 17:59:27.690 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllAvailablePolicies (InsurenceManagementSystemWebApi) in 92.9891ms
2025-05-28 17:59:27.696 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllAvailablePolicies (InsurenceManagementSystemWebApi)'
2025-05-28 17:59:27.701 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/api/Admin/available-policies/?page=1 - 200 null application/json; charset=utf-8 129.912ms
2025-05-28 18:00:28.711 +05:30 [INF] Request starting HTTP/1.1 PUT http://localhost:5016/api/Admin/available-policy - application/json 96
2025-05-28 18:00:28.733 +05:30 [INF] Authorization failed. These requirements were not met:
RolesAuthorizationRequirement:User.IsInRole must be true for one of the following roles: (Admin)
2025-05-28 18:00:28.742 +05:30 [INF] AuthenticationScheme: Bearer was challenged.
2025-05-28 18:00:28.745 +05:30 [INF] Request finished HTTP/1.1 PUT http://localhost:5016/api/Admin/available-policy - 401 0 null 33.6067ms
2025-05-28 18:01:12.496 +05:30 [INF] Request starting HTTP/1.1 PUT http://localhost:5016/api/Admin/available-policy?policyId=2 - application/json 106
2025-05-28 18:01:12.506 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.UpdateAvailablePolicy (InsurenceManagementSystemWebApi)'
2025-05-28 18:01:12.514 +05:30 [INF] Route matched with {action = "UpdateAvailablePolicy", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateAvailablePolicy(InsurenceManagementSystemWebApi.Applications.DTOs.AvailablePolicyRequestDto, Int32) on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 18:01:12.572 +05:30 [INF] Executed DbCommand (7ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[AvailablePolicyId], [a].[BasePremium], [a].[CoverageDetails], [a].[Name], [a].[ValidityPeriod]
FROM [AvailablePolicies] AS [a]
WHERE [a].[AvailablePolicyId] = @__p_0
2025-05-28 18:01:12.616 +05:30 [INF] Executed DbCommand (12ms) [Parameters=[@p4='?' (DbType = Int32), @p0='?' (Precision = 10) (Scale = 2) (DbType = Decimal), @p1='?' (Size = 4000), @p2='?' (Size = 4000), @p3='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [AvailablePolicies] SET [BasePremium] = @p0, [CoverageDetails] = @p1, [Name] = @p2, [ValidityPeriod] = @p3
OUTPUT 1
WHERE [AvailablePolicyId] = @p4;
2025-05-28 18:01:12.632 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-28 18:01:12.641 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.UpdateAvailablePolicy (InsurenceManagementSystemWebApi) in 118.456ms
2025-05-28 18:01:12.646 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.UpdateAvailablePolicy (InsurenceManagementSystemWebApi)'
2025-05-28 18:01:12.649 +05:30 [INF] Request finished HTTP/1.1 PUT http://localhost:5016/api/Admin/available-policy?policyId=2 - 200 null application/json; charset=utf-8 153.8827ms
2025-05-28 18:01:46.091 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/api/Admin/policy-requests - null null
2025-05-28 18:01:46.105 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllPolicyRequests (InsurenceManagementSystemWebApi)'
2025-05-28 18:01:46.116 +05:30 [INF] Route matched with {action = "GetAllPolicyRequests", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult`1[InsurenceManagementSystemWebApi.Applications.DTOs.PagedResult`1[InsurenceManagementSystemWebApi.Applications.DTOs.PolicyRequestStatusResponseDto]]] GetAllPolicyRequests(Int32, Int32) on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 18:01:46.177 +05:30 [INF] Executed DbCommand (36ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [p].[RequestId], [p].[AvailablePolicyId], [p].[CustomerId], [p].[RequestedOn], [p].[Status]
FROM [PolicyRequests] AS [p]
2025-05-28 18:01:46.208 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.PagedResult`1[[InsurenceManagementSystemWebApi.Applications.DTOs.PolicyRequestStatusResponseDto, InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], InsurenceManagementSystemWebApi, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-05-28 18:01:46.222 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllPolicyRequests (InsurenceManagementSystemWebApi) in 94.8287ms
2025-05-28 18:01:46.228 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.GetAllPolicyRequests (InsurenceManagementSystemWebApi)'
2025-05-28 18:01:46.232 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/api/Admin/policy-requests - 200 null application/json; charset=utf-8 141.0808ms
2025-05-28 18:02:11.157 +05:30 [INF] Request starting HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - application/json 107
2025-05-28 18:02:11.180 +05:30 [INF] Authorization failed. These requirements were not met:
RolesAuthorizationRequirement:User.IsInRole must be true for one of the following roles: (Admin)
2025-05-28 18:02:11.183 +05:30 [INF] AuthenticationScheme: Bearer was challenged.
2025-05-28 18:02:11.187 +05:30 [INF] Request finished HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - 401 0 null 29.9386ms
2025-05-28 18:02:19.561 +05:30 [INF] Request starting HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - application/json 107
2025-05-28 18:02:19.569 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi)'
2025-05-28 18:02:19.578 +05:30 [INF] Route matched with {action = "ApprovePolicyRequest", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] ApprovePolicyRequest(InsurenceManagementSystemWebApi.Applications.DTOs.AssignAgentRequestDto, Int32) on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 18:02:19.617 +05:30 [INF] Executed DbCommand (6ms) [Parameters=[@__requestId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[RequestId], [p].[AvailablePolicyId], [p].[CustomerId], [p].[RequestedOn], [p].[Status], [a].[AvailablePolicyId], [a].[BasePremium], [a].[CoverageDetails], [a].[Name], [a].[ValidityPeriod]
FROM [PolicyRequests] AS [p]
INNER JOIN [AvailablePolicies] AS [a] ON [p].[AvailablePolicyId] = [a].[AvailablePolicyId]
WHERE [p].[RequestId] = @__requestId_0
2025-05-28 18:02:19.663 +05:30 [INF] Executed DbCommand (10ms) [Parameters=[@p4='?' (DbType = Int32), @p0='?' (DbType = Int32), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [PolicyRequests] SET [AvailablePolicyId] = @p0, [CustomerId] = @p1, [RequestedOn] = @p2, [Status] = @p3
OUTPUT 1
WHERE [RequestId] = @p4;
2025-05-28 18:02:19.740 +05:30 [INF] Executed DbCommand (25ms) [Parameters=[@p0='?' (DbType = Int32), @p1='?' (DbType = Int32), @p2='?' (DbType = Int32), @p3='?' (DbType = DateTime2), @p4='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Policies] ([AgentId], [AvailablePolicyId], [CustomerId], [ExpiryDate], [IssuedDate])
OUTPUT INSERTED.[PolicyId]
VALUES (@p0, @p1, @p2, @p3, @p4);
2025-05-28 18:02:19.818 +05:30 [ERR] An exception occurred in the database while saving changes for context type 'InsurenceManagementSystemWebApi.Infrastructure.Persistance.InsuranceDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-28 18:02:19.979 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi) in 393.2643ms
2025-05-28 18:02:19.985 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi)'
2025-05-28 18:02:20.085 +05:30 [ERR] An error occurred.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at InsurenceManagementSystemWebApi.Infrastructure.Persistance.Repositories.PolicyRepository.AddAsync(Policy policy) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Infrastructure\Persistance\Repositories\PolicyRepository.cs:line 68
   at InsurenceManagementSystemWebApi.Applications.Services.AdminService.ApprovePolicyRequestAsync(AssignAgentRequestDto dto, Int32 requestId) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Applications\Services\AdminService.cs:line 296
   at InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest(AssignAgentRequestDto dto, Int32 requestId) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Controllers\AdminController.cs:line 122
   at Microsoft.AspNetCore.Mvc.Infrastructure.ActionMethodExecutor.TaskOfIActionResultExecutor.Execute(ActionContext actionContext, IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeActionMethodAsync>g__Awaited|12_0(ControllerActionInvoker invoker, ValueTask`1 actionResultValueTask)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeNextActionFilterAsync>g__Awaited|10_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Rethrow(ActionExecutedContextSealed context)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Next(State& next, Scope& scope, Object& state, Boolean& isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeInnerFilterAsync>g__Awaited|13_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeFilterPipelineAsync>g__Awaited|20_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at InsurenceManagementSystemWebApi.Applications.MiddleWares.ExceptionMiddleware.InvokeAsync(HttpContext context) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Applications\MiddleWares\ExceptionMiddleware.cs:line 32
2025-05-28 18:02:22.287 +05:30 [INF] Request finished HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - 500 null application/json 2726.7074ms
2025-05-28 18:05:58.397 +05:30 [INF] Request starting HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - application/json 107
2025-05-28 18:05:58.408 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi)'
2025-05-28 18:05:58.412 +05:30 [INF] Route matched with {action = "ApprovePolicyRequest", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] ApprovePolicyRequest(InsurenceManagementSystemWebApi.Applications.DTOs.AssignAgentRequestDto, Int32) on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 18:05:58.428 +05:30 [INF] Executed DbCommand (9ms) [Parameters=[@__requestId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[RequestId], [p].[AvailablePolicyId], [p].[CustomerId], [p].[RequestedOn], [p].[Status], [a].[AvailablePolicyId], [a].[BasePremium], [a].[CoverageDetails], [a].[Name], [a].[ValidityPeriod]
FROM [PolicyRequests] AS [p]
INNER JOIN [AvailablePolicies] AS [a] ON [p].[AvailablePolicyId] = [a].[AvailablePolicyId]
WHERE [p].[RequestId] = @__requestId_0
2025-05-28 18:05:58.452 +05:30 [INF] Executed DbCommand (11ms) [Parameters=[@p4='?' (DbType = Int32), @p0='?' (DbType = Int32), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [PolicyRequests] SET [AvailablePolicyId] = @p0, [CustomerId] = @p1, [RequestedOn] = @p2, [Status] = @p3
OUTPUT 1
WHERE [RequestId] = @p4;
2025-05-28 18:05:58.484 +05:30 [INF] Executed DbCommand (10ms) [Parameters=[@p0='?' (DbType = Int32), @p1='?' (DbType = Int32), @p2='?' (DbType = Int32), @p3='?' (DbType = DateTime2), @p4='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Policies] ([AgentId], [AvailablePolicyId], [CustomerId], [ExpiryDate], [IssuedDate])
OUTPUT INSERTED.[PolicyId]
VALUES (@p0, @p1, @p2, @p3, @p4);
2025-05-28 18:05:58.513 +05:30 [ERR] An exception occurred in the database while saving changes for context type 'InsurenceManagementSystemWebApi.Infrastructure.Persistance.InsuranceDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-28 18:05:58.685 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi) in 267.4984ms
2025-05-28 18:05:58.692 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi)'
2025-05-28 18:05:58.764 +05:30 [ERR] An error occurred.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at InsurenceManagementSystemWebApi.Infrastructure.Persistance.Repositories.PolicyRepository.AddAsync(Policy policy) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Infrastructure\Persistance\Repositories\PolicyRepository.cs:line 68
   at InsurenceManagementSystemWebApi.Applications.Services.AdminService.ApprovePolicyRequestAsync(AssignAgentRequestDto dto, Int32 requestId) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Applications\Services\AdminService.cs:line 296
   at InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest(AssignAgentRequestDto dto, Int32 requestId) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Controllers\AdminController.cs:line 122
   at Microsoft.AspNetCore.Mvc.Infrastructure.ActionMethodExecutor.TaskOfIActionResultExecutor.Execute(ActionContext actionContext, IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeActionMethodAsync>g__Awaited|12_0(ControllerActionInvoker invoker, ValueTask`1 actionResultValueTask)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeNextActionFilterAsync>g__Awaited|10_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Rethrow(ActionExecutedContextSealed context)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Next(State& next, Scope& scope, Object& state, Boolean& isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeInnerFilterAsync>g__Awaited|13_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeFilterPipelineAsync>g__Awaited|20_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at InsurenceManagementSystemWebApi.Applications.MiddleWares.ExceptionMiddleware.InvokeAsync(HttpContext context) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Applications\MiddleWares\ExceptionMiddleware.cs:line 32
2025-05-28 18:05:58.797 +05:30 [INF] Request finished HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - 500 null application/json 399.9976ms
2025-05-28 18:06:52.571 +05:30 [INF] Request starting HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - application/json 107
2025-05-28 18:06:52.582 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi)'
2025-05-28 18:06:52.584 +05:30 [INF] Route matched with {action = "ApprovePolicyRequest", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] ApprovePolicyRequest(InsurenceManagementSystemWebApi.Applications.DTOs.AssignAgentRequestDto, Int32) on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 18:07:11.975 +05:30 [INF] Executed DbCommand (37ms) [Parameters=[@__requestId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[RequestId], [p].[AvailablePolicyId], [p].[CustomerId], [p].[RequestedOn], [p].[Status], [a].[AvailablePolicyId], [a].[BasePremium], [a].[CoverageDetails], [a].[Name], [a].[ValidityPeriod]
FROM [PolicyRequests] AS [p]
INNER JOIN [AvailablePolicies] AS [a] ON [p].[AvailablePolicyId] = [a].[AvailablePolicyId]
WHERE [p].[RequestId] = @__requestId_0
2025-05-28 18:07:12.005 +05:30 [INF] Executed DbCommand (10ms) [Parameters=[@p4='?' (DbType = Int32), @p0='?' (DbType = Int32), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [PolicyRequests] SET [AvailablePolicyId] = @p0, [CustomerId] = @p1, [RequestedOn] = @p2, [Status] = @p3
OUTPUT 1
WHERE [RequestId] = @p4;
2025-05-28 18:07:12.023 +05:30 [INF] Executed DbCommand (8ms) [Parameters=[@p0='?' (DbType = Int32), @p1='?' (DbType = Int32), @p2='?' (DbType = Int32), @p3='?' (DbType = DateTime2), @p4='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Policies] ([AgentId], [AvailablePolicyId], [CustomerId], [ExpiryDate], [IssuedDate])
OUTPUT INSERTED.[PolicyId]
VALUES (@p0, @p1, @p2, @p3, @p4);
2025-05-28 18:07:12.042 +05:30 [ERR] An exception occurred in the database while saving changes for context type 'InsurenceManagementSystemWebApi.Infrastructure.Persistance.InsuranceDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-28 18:07:12.194 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi) in 19602.6571ms
2025-05-28 18:07:12.196 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi)'
2025-05-28 18:07:12.234 +05:30 [ERR] An error occurred.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at InsurenceManagementSystemWebApi.Infrastructure.Persistance.Repositories.PolicyRepository.AddAsync(Policy policy) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Infrastructure\Persistance\Repositories\PolicyRepository.cs:line 68
   at InsurenceManagementSystemWebApi.Applications.Services.AdminService.ApprovePolicyRequestAsync(AssignAgentRequestDto dto, Int32 requestId) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Applications\Services\AdminService.cs:line 296
   at InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest(AssignAgentRequestDto dto, Int32 requestId) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Controllers\AdminController.cs:line 122
   at Microsoft.AspNetCore.Mvc.Infrastructure.ActionMethodExecutor.TaskOfIActionResultExecutor.Execute(ActionContext actionContext, IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeActionMethodAsync>g__Awaited|12_0(ControllerActionInvoker invoker, ValueTask`1 actionResultValueTask)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeNextActionFilterAsync>g__Awaited|10_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Rethrow(ActionExecutedContextSealed context)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Next(State& next, Scope& scope, Object& state, Boolean& isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeInnerFilterAsync>g__Awaited|13_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeFilterPipelineAsync>g__Awaited|20_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at InsurenceManagementSystemWebApi.Applications.MiddleWares.ExceptionMiddleware.InvokeAsync(HttpContext context) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Applications\MiddleWares\ExceptionMiddleware.cs:line 32
2025-05-28 18:07:12.264 +05:30 [INF] Request finished HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - 500 null application/json 19693.6007ms
2025-05-28 18:07:25.215 +05:30 [INF] Request starting HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - application/json 107
2025-05-28 18:07:33.058 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi)'
2025-05-28 18:07:33.065 +05:30 [INF] Route matched with {action = "ApprovePolicyRequest", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] ApprovePolicyRequest(InsurenceManagementSystemWebApi.Applications.DTOs.AssignAgentRequestDto, Int32) on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 18:09:49.061 +05:30 [INF] Request starting HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - application/json 21
2025-05-28 18:09:49.074 +05:30 [INF] Executed DbCommand (27ms) [Parameters=[@__requestId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[RequestId], [p].[AvailablePolicyId], [p].[CustomerId], [p].[RequestedOn], [p].[Status], [a].[AvailablePolicyId], [a].[BasePremium], [a].[CoverageDetails], [a].[Name], [a].[ValidityPeriod]
FROM [PolicyRequests] AS [p]
INNER JOIN [AvailablePolicies] AS [a] ON [p].[AvailablePolicyId] = [a].[AvailablePolicyId]
WHERE [p].[RequestId] = @__requestId_0
2025-05-28 18:09:49.135 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi)'
2025-05-28 18:09:49.162 +05:30 [INF] Route matched with {action = "ApprovePolicyRequest", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] ApprovePolicyRequest(InsurenceManagementSystemWebApi.Applications.DTOs.AssignAgentRequestDto, Int32) on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 18:09:49.166 +05:30 [INF] Executed DbCommand (11ms) [Parameters=[@p4='?' (DbType = Int32), @p0='?' (DbType = Int32), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [PolicyRequests] SET [AvailablePolicyId] = @p0, [CustomerId] = @p1, [RequestedOn] = @p2, [Status] = @p3
OUTPUT 1
WHERE [RequestId] = @p4;
2025-05-28 18:09:51.348 +05:30 [INF] Executed DbCommand (11ms) [Parameters=[@p0='?' (DbType = Int32), @p1='?' (DbType = Int32), @p2='?' (DbType = Int32), @p3='?' (DbType = DateTime2), @p4='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Policies] ([AgentId], [AvailablePolicyId], [CustomerId], [ExpiryDate], [IssuedDate])
OUTPUT INSERTED.[PolicyId]
VALUES (@p0, @p1, @p2, @p3, @p4);
2025-05-28 18:09:51.358 +05:30 [INF] Executed DbCommand (6ms) [Parameters=[@__requestId_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [p].[RequestId], [p].[AvailablePolicyId], [p].[CustomerId], [p].[RequestedOn], [p].[Status], [a].[AvailablePolicyId], [a].[BasePremium], [a].[CoverageDetails], [a].[Name], [a].[ValidityPeriod]
FROM [PolicyRequests] AS [p]
INNER JOIN [AvailablePolicies] AS [a] ON [p].[AvailablePolicyId] = [a].[AvailablePolicyId]
WHERE [p].[RequestId] = @__requestId_0
2025-05-28 18:09:51.381 +05:30 [ERR] An exception occurred in the database while saving changes for context type 'InsurenceManagementSystemWebApi.Infrastructure.Persistance.InsuranceDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-28 18:09:51.410 +05:30 [INF] Executed DbCommand (17ms) [Parameters=[@p4='?' (DbType = Int32), @p0='?' (DbType = Int32), @p1='?' (DbType = Int32), @p2='?' (DbType = DateTime2), @p3='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [PolicyRequests] SET [AvailablePolicyId] = @p0, [CustomerId] = @p1, [RequestedOn] = @p2, [Status] = @p3
OUTPUT 1
WHERE [RequestId] = @p4;
2025-05-28 18:09:51.653 +05:30 [INF] Executed DbCommand (18ms) [Parameters=[@p0='?' (DbType = Int32), @p1='?' (DbType = Int32), @p2='?' (DbType = Int32), @p3='?' (DbType = DateTime2), @p4='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Policies] ([AgentId], [AvailablePolicyId], [CustomerId], [ExpiryDate], [IssuedDate])
OUTPUT INSERTED.[PolicyId]
VALUES (@p0, @p1, @p2, @p3, @p4);
2025-05-28 18:09:51.654 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi) in 138574.6799ms
2025-05-28 18:09:51.670 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi)'
2025-05-28 18:09:51.785 +05:30 [ERR] An error occurred.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_Policies_Agents_AgentId". The conflict occurred in database "InsuranceManagementSystem", table "dbo.Agents", column 'AgentId'.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:782cf8d3-bab1-4591-a859-54dbf905fda4
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at InsurenceManagementSystemWebApi.Infrastructure.Persistance.Repositories.PolicyRepository.AddAsync(Policy policy) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Infrastructure\Persistance\Repositories\PolicyRepository.cs:line 68
   at InsurenceManagementSystemWebApi.Applications.Services.AdminService.ApprovePolicyRequestAsync(AssignAgentRequestDto dto, Int32 requestId) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Applications\Services\AdminService.cs:line 296
   at InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest(AssignAgentRequestDto dto, Int32 requestId) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Controllers\AdminController.cs:line 122
   at Microsoft.AspNetCore.Mvc.Infrastructure.ActionMethodExecutor.TaskOfIActionResultExecutor.Execute(ActionContext actionContext, IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeActionMethodAsync>g__Awaited|12_0(ControllerActionInvoker invoker, ValueTask`1 actionResultValueTask)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeNextActionFilterAsync>g__Awaited|10_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Rethrow(ActionExecutedContextSealed context)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Next(State& next, Scope& scope, Object& state, Boolean& isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeInnerFilterAsync>g__Awaited|13_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeFilterPipelineAsync>g__Awaited|20_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)
   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)
   at InsurenceManagementSystemWebApi.Applications.MiddleWares.ExceptionMiddleware.InvokeAsync(HttpContext context) in C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi\Applications\MiddleWares\ExceptionMiddleware.cs:line 32
2025-05-28 18:09:51.852 +05:30 [INF] Request finished HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - 500 null application/json 146636.5515ms
2025-05-28 18:09:51.863 +05:30 [INF] Executed DbCommand (13ms) [Parameters=[@p0='?' (DbType = Int32), @p1='?' (DbType = DateTime2), @p2='?' (DbType = Int32), @p3='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Notifications] ([AgentId], [CreatedAt], [CustomerId], [Message])
OUTPUT INSERTED.[NotificationId]
VALUES (@p0, @p1, @p2, @p3);
2025-05-28 18:09:52.009 +05:30 [INF] Executed DbCommand (15ms) [Parameters=[@p0='?' (DbType = Int32), @p1='?' (DbType = DateTime2), @p2='?' (DbType = Int32), @p3='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [Notifications] ([AgentId], [CreatedAt], [CustomerId], [Message])
OUTPUT INSERTED.[NotificationId]
VALUES (@p0, @p1, @p2, @p3);
2025-05-28 18:09:54.145 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-28 18:09:56.168 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi) in 6993.1496ms
2025-05-28 18:09:56.174 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.ApprovePolicyRequest (InsurenceManagementSystemWebApi)'
2025-05-28 18:09:56.784 +05:30 [INF] Request finished HTTP/1.1 PUT http://localhost:5016/api/Admin/4/approve-policy-request - 200 null application/json; charset=utf-8 7725.681ms
2025-05-28 18:14:26.301 +05:30 [INF] User profile is available. Using 'C:\Users\2403521\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-05-28 18:14:26.772 +05:30 [INF] Now listening on: http://localhost:5016
2025-05-28 18:14:26.910 +05:30 [INF] Application started. Press Ctrl+C to shut down.
2025-05-28 18:14:26.911 +05:30 [INF] Hosting environment: Development
2025-05-28 18:14:26.912 +05:30 [INF] Content root path: C:\Users\2403521\Downloads\InsuranceManagementSystemFinal\InsuranceManagementSystem\InsuranceManagementSystem Final\InsurenceManagementSystemWebApi
2025-05-28 18:14:27.322 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/swagger/index.html - null null
2025-05-28 18:14:30.470 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/swagger/index.html - 200 null text/html;charset=utf-8 3159.8993ms
2025-05-28 18:14:30.527 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/_framework/aspnetcore-browser-refresh.js - null null
2025-05-28 18:14:30.532 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/_framework/aspnetcore-browser-refresh.js - 200 16547 application/javascript; charset=utf-8 4.9437ms
2025-05-28 18:14:30.553 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/_vs/browserLink - null null
2025-05-28 18:14:30.590 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/_vs/browserLink - 200 null text/javascript; charset=UTF-8 37.1064ms
2025-05-28 18:14:30.827 +05:30 [INF] Request starting HTTP/1.1 GET http://localhost:5016/swagger/v1/swagger.json - null null
2025-05-28 18:14:30.856 +05:30 [INF] Request finished HTTP/1.1 GET http://localhost:5016/swagger/v1/swagger.json - 200 null application/json;charset=utf-8 28.6847ms
2025-05-28 18:15:17.071 +05:30 [INF] Request starting HTTP/1.1 PUT http://localhost:5016/api/Admin/2/available-policy - application/json 106
2025-05-28 18:15:17.320 +05:30 [WRN] Failed to determine the https port for redirect.
2025-05-28 18:15:17.334 +05:30 [INF] Executing endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.UpdateAvailablePolicy (InsurenceManagementSystemWebApi)'
2025-05-28 18:15:17.370 +05:30 [INF] Route matched with {action = "UpdateAvailablePolicy", controller = "Admin"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] UpdateAvailablePolicy(InsurenceManagementSystemWebApi.Applications.DTOs.AvailablePolicyRequestDto, Int32) on controller InsurenceManagementSystemWebApi.Controllers.AdminController (InsurenceManagementSystemWebApi).
2025-05-28 18:15:21.439 +05:30 [INF] Executed DbCommand (225ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[AvailablePolicyId], [a].[BasePremium], [a].[CoverageDetails], [a].[Name], [a].[ValidityPeriod]
FROM [AvailablePolicies] AS [a]
WHERE [a].[AvailablePolicyId] = @__p_0
2025-05-28 18:15:21.584 +05:30 [INF] Executed DbCommand (15ms) [Parameters=[@p4='?' (DbType = Int32), @p0='?' (Precision = 10) (Scale = 2) (DbType = Decimal), @p1='?' (Size = 4000), @p2='?' (Size = 4000), @p3='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
UPDATE [AvailablePolicies] SET [BasePremium] = @p0, [CoverageDetails] = @p1, [Name] = @p2, [ValidityPeriod] = @p3
OUTPUT 1
WHERE [AvailablePolicyId] = @p4;
2025-05-28 18:15:21.656 +05:30 [INF] Executing OkObjectResult, writing value of type 'InsurenceManagementSystemWebApi.Shared.Common.OperationResult`1[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-05-28 18:15:21.688 +05:30 [INF] Executed action InsurenceManagementSystemWebApi.Controllers.AdminController.UpdateAvailablePolicy (InsurenceManagementSystemWebApi) in 4305.6181ms
2025-05-28 18:15:21.696 +05:30 [INF] Executed endpoint 'InsurenceManagementSystemWebApi.Controllers.AdminController.UpdateAvailablePolicy (InsurenceManagementSystemWebApi)'
2025-05-28 18:15:21.723 +05:30 [INF] Request finished HTTP/1.1 PUT http://localhost:5016/api/Admin/2/available-policy - 200 null application/json; charset=utf-8 4652.182ms
